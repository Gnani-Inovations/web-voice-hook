{"version":3,"file":"useWebVoice.js","names":["AudioMotionAnalyzer","useCallback","useMemo","useRef","useState","audioProcessorSource","applyCustomColor","base64ToPCM16Data","convertPCMDataToFloat32","getBase64Audio","getVisualizerOptions","resampleAudio","resetAudioInput","SAMPLE_RATE","CHANNELS","BITS_PER_SAMPLE","defaultLogger","info","arg","args","console","log","error","useWebSocketAudio","websocketUrl","workletPath","visualizerOptions","elementId","visualizerElementId","color","visualizerColor","options","events","eventsOption","logger","loggerOption","onOpen","onClose","onException","isPlaying","setIsPlaying","websocketRef","audioContextRef","sourceNodeRef","isPlayingRef","isFirstChunk","streamRef","isAudioNodesConnected","isCleanedUp","backendSampleRate","isStopReceived","lastSentTTSEvent","chunkReceivedAt","nextPlayTimeRef","pendingSourcesRef","analyzerRef","pingIntervalRef","isConnected","setIsConnected","isPlayingAudio","bufferSize","audioBufferRef","getOrCreateAudioContext","current","state","window","AudioContext","webkitAudioContext","sampleRate","latencyHint","initializeVisualizer","source","connectInput","analyzer","document","getElementById","start","setupAudioStream","async","navigator","mediaDevices","getUserMedia","audio","channelCount","echoCancellation","ideal","noiseSuppression","autoGainControl","audioContext","createMediaStreamSource","compressor","createDynamicsCompressor","threshold","value","knee","ratio","attack","release","gainNode","createGain","gain","connect","e","startProcessing","stopProcessing","isProcessing","audioWorkletNode","sourceNode","useEmbedded","undefined","workletUrl","URL","createObjectURL","Blob","type","audioWorklet","addModule","revokeObjectURL","AudioWorkletNode","numberOfInputs","numberOfOutputs","processorOptions","port","onmessage","event","readyState","WebSocket","OPEN","data","timestamp","base64Data","send","JSON","stringify","media","payload","disconnect","processAudioChunk","pcm16Data","float32Data","rightSampled","push","totalBufferedSamples","reduce","acc","chunk","length","playNextChunk","bufferedSamples","shouldPlayRemainder","totalLength","chunks","shift","audioData","Float32Array","offset","set","audioBuffer","createBuffer","getChannelData","createBufferSource","buffer","destination","safetyOffset","startTime","Math","max","currentTime","tts_playing","onended","close","duration","processAudioMessage","message","Date","now","sample_rate","includes","cleanup","clearInterval","CONNECTING","stop","destroy","getTracks","forEach","track","enabled","removeTrack","ws","onopen","metadata","toString","setInterval","parse","onclose","reason","location","reload","onerror","reconnect","onConnectionSuccess","startRecording","stopRecording","isRecording"],"sources":["../src/useWebVoice.ts"],"mappings":"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","ignoreList":[]}