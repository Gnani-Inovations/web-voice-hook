import AudioMotionAnalyzer from"audiomotion-analyzer";import{useCallback,useMemo,useRef,useState}from"react";import{audioProcessorSource}from"./audioProcessorSource.generated";import{applyCustomColor,base64ToPCM16Data,convertPCMDataToFloat32,getBase64Audio,getVisualizerOptions,resampleAudio,resetAudioInput}from"./webVoiceUtils";const SAMPLE_RATE=44100;export const CHANNELS=1;export const BITS_PER_SAMPLE=16;const defaultLogger={info:(e,...r)=>console.log("[GnaniWebVoice]",e,...r),error:(e,...r)=>console.error("[GnaniWebVoice]",e,...r)};export const useWebSocketAudio=({websocketUrl:e,workletPath:r,visualizerOptions:{elementId:t,color:n,options:c}={},events:o,logger:u})=>{const{onOpen:a,onClose:s,onException:i}=o??{},l=u??defaultLogger,[d,p]=useState(!1),f=useRef(null),g=useRef(null),m=useRef(null),y=useRef(!1),S=useRef(!0),b=useRef(),k=useRef(!1),v=useRef(!1),C=useRef(44100),R=useRef(!1),h=useRef(!1),w=useRef(0),E=useRef(null),[O,P]=useState(!1),A=useRef(!1),N=useRef([]),T=useCallback((()=>(g.current&&"closed"!==g.current.state||(g.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100,latencyHint:"playback"})),g.current)),[]),L=useCallback((e=>{if(!t||E.current||v.current)E.current?.connectInput(e);else{const r=new AudioMotionAnalyzer(document.getElementById(t),{...c??getVisualizerOptions(e)});r.start(),n&&applyCustomColor(r,n),E.current=r}}),[]),I=useCallback((async()=>{if(!k.current){resetAudioInput(b.current);try{b.current=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:44100,channelCount:1,echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0},autoGainControl:{ideal:!0}}});const e=T(),r=e.createMediaStreamSource(b.current),t=e.createDynamicsCompressor();t.threshold.value=-30,t.knee.value=40,t.ratio.value=8,t.attack.value=.002,t.release.value=.1;const n=e.createGain();n.gain.value=1.2,r.connect(t).connect(n),L(r),k.current=!0}catch(e){throw l.error("Error setting up audio stream:",e),i?.(e),e}}}),[T,L]),{startProcessing:M,stopProcessing:W,isProcessing:_}=useMemo((()=>{let e=null,t=null;return{startProcessing:async()=>{if(b.current)try{const n=T(),c=void 0===r||""===r,o=c?URL.createObjectURL(new Blob([audioProcessorSource],{type:"application/javascript"})):r;try{await n.audioWorklet.addModule(o)}finally{c&&URL.revokeObjectURL(o)}t=n.createMediaStreamSource(b.current),e=new AudioWorkletNode(n,"audio-processor",{numberOfInputs:1,numberOfOutputs:1,channelCount:1,processorOptions:{sampleRate:n.sampleRate}}),e.port.onmessage=e=>{if(f.current?.readyState===WebSocket.OPEN){const{data:r,timestamp:t}=e.data,n=getBase64Audio(r);f.current.send(JSON.stringify({event:"media",media:{payload:n,timestamp:t}}))}},t.connect(e)}catch(e){l.error("Failed to start audio processing:",e),i?.(e)}},stopProcessing:()=>{e&&(e.disconnect(),e=null),t&&(t.disconnect(),t=null)},isProcessing:!!e}}),[T,r]),D=useCallback((e=>{T();try{const r=base64ToPCM16Data(e),t=convertPCMDataToFloat32(r),n=44100===C.current?t:resampleAudio(t,C.current,44100);N.current.push(n),N.current.reduce(((e,r)=>e+r.length),0)>=44100&&B()}catch(e){l.error("Error processing audio chunk:",e)}}),[T]),B=useCallback((()=>{const e=T();if(!e||A.current)return;let r;if(0===N.current.length){A.current=!1,p(!1),f.current?.send(JSON.stringify({event:"TTS_PLAYING",media:{tts_playing:!1}})),h.current=!1;const e=Math.floor(1*C.current*2);r=new Float32Array(e).fill(0)}else{h.current||(f.current?.send(JSON.stringify({event:"TTS_PLAYING",media:{tts_playing:!0}})),h.current=!0),A.current=!0,p(!0);let e=0;const t=[];for(;N.current.length>0&&e<44100;){const r=N.current.shift();t.push(r),e+=r.length}r=new Float32Array(e);let n=0;for(const e of t)r.set(e,n),n+=e.length}const t=e.createBuffer(1,r.length,44100);t.getChannelData(0).set(r);const n=e.createBufferSource();n.buffer=t,n.connect(e.destination),L(n),n.onended=()=>{A.current=!1,N.current.length>0?B():(p(!1),f.current?.send(JSON.stringify({event:"TTS_PLAYING",media:{tts_playing:!1}})),h.current=!1,R.current&&f.current?.close())},n.start(),m.current=n,y.current=!0}),[T,L]),G=useCallback((async e=>{try{"media"===e.event&&e.media?.payload?(0===w.current&&(w.current=Date.now(),l.info("Chunk received at:",w.current)),C.current=e.sample_rate??44100,D(e.media.payload)):["barge","BARGE"].includes(e.event)?(l.info("Barged"),N.current=[]):"EOC"===e.event?(l.info("EOC event occurred"),f.current?.send(JSON.stringify({event:"EOC"}))):"stop"===e.event?(l.info("Stop event occurred"),f.current?.readyState===WebSocket.OPEN&&(R.current=!0)):l.info("Unhandled message type:",e)}catch(e){l.error("Error processing audio message:",e)}}),[]),J=useCallback((e=>{if(!v.current){if(v.current=!0,W(),f.current&&(f.current.readyState!==WebSocket.OPEN&&f.current.readyState!==WebSocket.CONNECTING||f.current.close(),f.current=null),E.current?.stop(),E.current?.destroy(),g.current&&(g.current.close(),g.current=null),m.current&&(m.current.stop(),m.current.disconnect(),m.current=null),b.current){b.current.getTracks().forEach((e=>{e.stop(),e.enabled=!1,b.current?.removeTrack(e)})),b.current=void 0}N.current=[],y.current=!1,k.current=!1,S.current=!0,A.current=!1,R.current=!1,p(!1),P(!1),s?.(e)}}),[W,s]),U=useCallback((()=>{if(!e||f.current||v.current||O)return;v.current=!1,S.current=!0;const r=new WebSocket(e);f.current=r,r.onopen=async()=>{v.current?r.close():(P(!0),await I(),await M(),r.send(JSON.stringify({event:"start"})))},r.onmessage=e=>{if(!v.current)try{const r=JSON.parse(e.data);r&&G(r)}catch(e){l.error("Error parsing websocket message:",e)}},r.onclose=e=>{"LINK_EXPIRED"===e.reason&&(l.info("Link expired"),location.reload()),v.current||J("server"),W()},r.onerror=e=>{l.error("WebSocket error:",e),i?.(e),v.current||J("server")}}),[e,a,s,i,I,M,O]),x=useCallback((()=>{J("client")}),[J]),z=useCallback((r=>{if(f.current&&(f.current.close(),f.current=null),v.current=!1,S.current=!0,y.current=!1,k.current=!1,A.current=!1,R.current=!1,P(!1),p(!1),N.current=[],g.current&&(g.current.close(),g.current=null),m.current&&(m.current.stop(),m.current.disconnect(),m.current=null),E.current&&(E.current.stop(),E.current.destroy(),E.current=null),b.current){b.current.getTracks().forEach((e=>{e.stop(),e.enabled=!1,b.current?.removeTrack(e)})),b.current=void 0}if(W(),!e)return void l.error("Cannot reconnect: websocketUrl is required");const t=new WebSocket(e);f.current=t,t.onopen=async()=>{v.current?t.close():(P(!0),await I(),await M(),t.send(JSON.stringify({event:"start"})),r?.())},t.onmessage=e=>{if(!v.current)try{const r=JSON.parse(e.data);r&&G(r)}catch(e){l.error("Error parsing websocket message:",e),i?.(e)}},t.onclose=e=>{"LINK_EXPIRED"===e.reason&&(l.info("Link expired"),location.reload()),v.current||J("server"),W()},t.onerror=e=>{l.error("WebSocket error:",e),i?.(e),v.current||J("server")}}),[e,a,s,i,I,M,W,J]);return{isConnected:O,isPlaying:d,startRecording:M,stopRecording:W,isRecording:_,connect:U,disconnect:x,reconnect:z}};
//# sourceMappingURL=useWebVoice.js.map