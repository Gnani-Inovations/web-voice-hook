import AudioMotionAnalyzer from"audiomotion-analyzer";import{useCallback,useMemo,useRef,useState}from"react";import{audioProcessorSource}from"./audioProcessorSource.generated";import{applyCustomColor,base64ToPCM16Data,convertPCMDataToFloat32,getBase64Audio,getVisualizerOptions,resampleAudio,resetAudioInput}from"./webVoiceUtils";const SAMPLE_RATE=44100;export const CHANNELS=1;export const BITS_PER_SAMPLE=16;const defaultLogger={info:(e,...r)=>console.log("[GnaniWebVoice]",e,...r),error:(e,...r)=>console.error("[GnaniWebVoice]",e,...r)};export const useWebSocketAudio=({websocketUrl:e,workletPath:r,visualizerOptions:{elementId:t,color:n,options:c}={},events:o,logger:u})=>{const{onOpen:a,onClose:s,onException:i}=o??{},l=u??defaultLogger,[d,p]=useState(!1),f=useRef(null),g=useRef(null),m=useRef(null),S=useRef(!1),v=useRef(!0),y=useRef(),b=useRef(!1),k=useRef(!1),C=useRef(44100),R=useRef(!1),h=useRef(!1),O=useRef(0),w=useRef(0),E=useRef(0),P=useRef(null),N=useRef(null),[I,A]=useState(!1),M=useRef(!1),T=44100,L=useRef([]),W=useCallback((()=>(g.current&&"closed"!==g.current.state||(g.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100,latencyHint:"playback"})),g.current)),[]),D=useCallback((e=>{if(!t||P.current||k.current)P.current?.connectInput(e);else{const r=new AudioMotionAnalyzer(document.getElementById(t),{...c??getVisualizerOptions(e)});r.start(),n&&applyCustomColor(r,n),P.current=r}}),[]),J=useCallback((async()=>{if(!b.current){resetAudioInput(y.current);try{y.current=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:44100,channelCount:1,echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0},autoGainControl:{ideal:!0}}});const e=W(),r=e.createMediaStreamSource(y.current),t=e.createDynamicsCompressor();t.threshold.value=-30,t.knee.value=40,t.ratio.value=8,t.attack.value=.002,t.release.value=.1;const n=e.createGain();n.gain.value=1.2,r.connect(t).connect(n),D(r),b.current=!0}catch(e){throw l.error("Error setting up audio stream:",e),i?.(e),e}}}),[W,D]),{startProcessing:x,stopProcessing:_,isProcessing:B}=useMemo((()=>{let e=null,t=null;return{startProcessing:async()=>{if(y.current)try{const n=W(),c=void 0===r||""===r,o=c?URL.createObjectURL(new Blob([audioProcessorSource],{type:"application/javascript"})):r;try{await n.audioWorklet.addModule(o)}finally{c&&URL.revokeObjectURL(o)}t=n.createMediaStreamSource(y.current),e=new AudioWorkletNode(n,"audio-processor",{numberOfInputs:1,numberOfOutputs:1,channelCount:1,processorOptions:{sampleRate:n.sampleRate}}),e.port.onmessage=e=>{if(f.current?.readyState===WebSocket.OPEN){const{data:r,timestamp:t}=e.data,n=getBase64Audio(r);f.current.send(JSON.stringify({event:"media",media:{payload:n,timestamp:t}}))}},t.connect(e)}catch(e){l.error("Failed to start audio processing:",e),i?.(e)}},stopProcessing:()=>{e&&(e.disconnect(),e=null),t&&(t.disconnect(),t=null)},isProcessing:!!e}}),[W,r]),U=useCallback((e=>{W();try{const r=base64ToPCM16Data(e),t=convertPCMDataToFloat32(r),n=44100===C.current?t:resampleAudio(t,C.current,44100);L.current.push(n);const c=L.current.reduce(((e,r)=>e+r.length),0);(c>=T||M.current||R.current&&c>0)&&G()}catch(e){l.error("Error processing audio chunk:",e)}}),[W]),G=useCallback((()=>{const e=W();if(!e)return;let r=L.current.reduce(((e,r)=>e+r.length),0);const t=R.current&&r>0;if(M.current||!(r<T)||t)for(;L.current.length>0&&(t||M.current||!(r<T));){let t=0;const n=[];for(;L.current.length>0&&t<T;){const e=L.current.shift();n.push(e),t+=e.length}if(0===t)break;const c=new Float32Array(t);let o=0;for(const e of n)c.set(e,o),o+=e.length;const u=e.createBuffer(1,c.length,44100);u.getChannelData(0).set(c);const a=e.createBufferSource();a.buffer=u,a.connect(e.destination),D(a);const s=.02,i=Math.max(e.currentTime+s,w.current||0);h.current||(f.current?.send(JSON.stringify({event:"TTS_PLAYING",media:{tts_playing:!0}})),h.current=!0),M.current=!0,p(!0),E.current+=1,a.onended=()=>{E.current=Math.max(0,E.current-1),0===E.current&&0===L.current.length&&(M.current=!1,p(!1),f.current?.send(JSON.stringify({event:"TTS_PLAYING",media:{tts_playing:!1}})),h.current=!1,R.current&&f.current?.close())},a.start(i),w.current=i+u.duration,m.current=a,S.current=!0,r-=t}}),[W,D]),z=useCallback((async e=>{try{"media"===e.event&&e.media?.payload?(0===O.current&&(O.current=Date.now(),l.info("Chunk received at:",O.current)),C.current=e.sample_rate??44100,U(e.media.payload)):["barge","BARGE"].includes(e.event)?(l.info("Barged"),L.current=[]):"EOC"===e.event?(l.info("EOC event occurred"),f.current?.send(JSON.stringify({event:"EOC"}))):"stop"===e.event?(l.info("Stop event occurred"),f.current?.readyState===WebSocket.OPEN&&(R.current=!0),L.current.length>0&&G()):l.info("Unhandled message type:",e)}catch(e){l.error("Error processing audio message:",e)}}),[G,U]),V=useCallback((e=>{if(!k.current){if(k.current=!0,_(),N.current&&(clearInterval(N.current),N.current=null),f.current&&(f.current.readyState!==WebSocket.OPEN&&f.current.readyState!==WebSocket.CONNECTING||f.current.close(),f.current=null),P.current?.stop(),P.current?.destroy(),g.current&&(g.current.close(),g.current=null),m.current&&(m.current.stop(),m.current.disconnect(),m.current=null),y.current){y.current.getTracks().forEach((e=>{e.stop(),e.enabled=!1,y.current?.removeTrack(e)})),y.current=void 0}L.current=[],S.current=!1,b.current=!1,v.current=!0,M.current=!1,R.current=!1,w.current=0,E.current=0,p(!1),A(!1),s?.(e)}}),[_,s]),F=useCallback((()=>{if(!e||f.current||k.current||I)return;k.current=!1,v.current=!0;const r=new WebSocket(e);f.current=r,r.onopen=async()=>{k.current?r.close():(A(!0),f.current?.send(JSON.stringify({event:"ping",metadata:{timestamp:Date.now().toString()}})),N.current&&(clearInterval(N.current),N.current=null),N.current=setInterval((()=>{k.current||f.current?.readyState!==WebSocket.OPEN?N.current&&(clearInterval(N.current),N.current=null):f.current?.send(JSON.stringify({event:"ping",metadata:{timestamp:Date.now().toString()}}))}),1e4),await J(),await x(),r.send(JSON.stringify({event:"start"})))},r.onmessage=e=>{if(!k.current)try{const r=JSON.parse(e.data);r&&z(r)}catch(e){l.error("Error parsing websocket message:",e)}},r.onclose=e=>{N.current&&(clearInterval(N.current),N.current=null);"LINK_EXPIRED"===e.reason&&(l.info("Link expired"),location.reload()),k.current||V("server"),_()},r.onerror=e=>{l.error("WebSocket error:",e),i?.(e),k.current||V("server")}}),[e,a,s,i,J,x,I]),j=useCallback((()=>{V("client")}),[V]),H=useCallback((r=>{if(f.current&&(f.current.close(),f.current=null),k.current=!1,v.current=!0,S.current=!1,b.current=!1,M.current=!1,R.current=!1,w.current=0,E.current=0,A(!1),p(!1),L.current=[],g.current&&(g.current.close(),g.current=null),m.current&&(m.current.stop(),m.current.disconnect(),m.current=null),P.current&&(P.current.stop(),P.current.destroy(),P.current=null),y.current){y.current.getTracks().forEach((e=>{e.stop(),e.enabled=!1,y.current?.removeTrack(e)})),y.current=void 0}if(_(),!e)return void l.error("Cannot reconnect: websocketUrl is required");const t=new WebSocket(e);f.current=t,t.onopen=async()=>{k.current?t.close():(A(!0),N.current&&(clearInterval(N.current),N.current=null),N.current=setInterval((()=>{k.current||f.current?.readyState!==WebSocket.OPEN?N.current&&(clearInterval(N.current),N.current=null):f.current?.send(JSON.stringify({event:"ping",metadata:{timestamp:Date.now().toString()}}))}),1e4),await J(),await x(),t.send(JSON.stringify({event:"start"})),r?.())},t.onmessage=e=>{if(!k.current)try{const r=JSON.parse(e.data);r&&z(r)}catch(e){l.error("Error parsing websocket message:",e),i?.(e)}},t.onclose=e=>{N.current&&(clearInterval(N.current),N.current=null);"LINK_EXPIRED"===e.reason&&(l.info("Link expired"),location.reload()),k.current||V("server"),_()},t.onerror=e=>{l.error("WebSocket error:",e),i?.(e),k.current||V("server")}}),[e,a,s,i,J,x,_,V]);return{isConnected:I,isPlaying:d,startRecording:x,stopRecording:_,isRecording:B,connect:F,disconnect:j,reconnect:H}};
//# sourceMappingURL=useWebVoice.js.map